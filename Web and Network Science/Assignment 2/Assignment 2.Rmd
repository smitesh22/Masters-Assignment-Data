---
title: "Assignment 2"
author: "Smitesh Patil"
date: "2023-03-10"
output:
  pdf_document: default
  html_document: default
  
---

```{r setup, include=TRUE, cache = FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r}
library(igraph)
library(ggraph)
library(ggrepel)
library(kableExtra)
library(gt)
library(tidyr)
library(dplyr)


# reading the graph 
g<- read_graph(file="./WordPairs.txt",format="pajek")
g<- as.undirected(g)
g<- simplify(g)

cues <- read.table("./cue.txt", header = F, sep="\t", skip=4)

V(g)$cue<-cues[[1]]

#checking the diameter value
print(diameter(g, weights = NA))

```

```{r}

check_cue_words <- function(target_node_name1, target_node_name2){
# test if the selected words are cue words

  if(V(g)[target_node_name1]$cue & V(g)[target_node_name2]$cue){
    cat("Both target words are cue words \n")
  }else{
    cat("Both target words are NOT cue words \n")
    cat(target_node_name1, "cue = ", as.logical(V(g)[target_node_name1]$cue ),"\n")
    cat(target_node_name2, "cue = ", as.logical(V(g)[target_node_name2]$cue ),"\n")
  }
}

```

```{r}

random_walk_topic_network <- function(g,target_node_names, steps, walks, mode, topn){
  
  vertices <- c()
  
  for (i in 1:2){
    for (j in 1:walks){
     vertices <- c(vertices, list(random_walk(g, target_node_names[i], steps, mode = mode)))
   }
  }
  
  frequency_target <- head(sort(table(names(unlist(vertices))), decreasing = TRUE), topn)
  unique_words <- names(frequency_target)
  
  return(unique_words)
}

centralities = function(word_association_network){
  page_rank <- page_rank(word_association_network)$vector
  page_rank <- na.omit(page_rank[!names(page_rank) %in% c(target_word1, target_word2)])
  page_rank <- sort(page_rank, decreasing = TRUE)[1:5]

  betweenness <- betweenness(word_association_network)
  betweenness <- betweenness[!names(betweenness) %in% c(target_word1, target_word2)]
  betweenness <- sort(betweenness, decreasing = TRUE)[1:5]

  eigen_centrality <- eigen_centrality(word_association_network)$vector
  eigen_centrality <- eigen_centrality[!names(eigen_centrality) %in% c(target_word1, target_word2)]
  eigen_centrality <- sort(eigen_centrality, decreasing = TRUE)[1:5]
  
  return(list(page_rank, betweenness, eigen_centrality))
}

```

```{r}
target_word1 <- "BOOK"
target_word2 <- "DICTIONARY"

check_cue_words(target_word1, target_word2)

out <- random_walk_topic_network(g, c(target_word1, target_word2), 3, 100, "all", 160)

Vertices_in_word_association <- V(g)[name %in% out]

word_association_network1 <- induced.subgraph(g, Vertices_in_word_association)

centrality = centralities(word_association_network1)

df <- tibble(names(centrality[[1]]) , names(centrality[[2]]), names(centrality[[3]]))
colnames(df) <- c("page_rank", "betweeness", "eigen_centrality")

df %>% gt() %>%
  tab_header(paste0("Top 5 words based on centralities based on word association network for
             words ",target_word1 , " and ",target_word2))
vertex_size <- 2.5 + degree(g)/12
cex_size <-2 + degree(g)/36

#ggraph(word_association_network, layout = "fr") 
vertex_size <- 2.5 + degree(word_association_network1)/10
cex_size <-2 + degree(word_association_network1)/30
ggraph(word_association_network1, layout = "fr")+
  geom_edge_link(start_cap = circle(2.5, "mm"),
                   end_cap = circle(2.5, "mm"),
                   edge_width = 0.2,
                   alpha = 0.2)+
  geom_node_point(aes(size = vertex_size), 
                    alpha = 0.8, 
                    colour = ifelse(V(word_association_network1) %in% c("HEART", "HEAD"), "yellow","red")) +
  geom_node_text(
      aes(label = name),
      fontface = "bold",
      size = cex_size,
      repel = TRUE
    ) 
```

```{r}

target_word1 <- "CRIME"
target_word2 <- "TRIAL"

check_cue_words(target_word1, target_word2)

out <- random_walk_topic_network(g, c(target_word1, target_word2), 3, 100, "all", 160)

Vertices_in_word_association <- V(g)[name %in% out]

word_association_network2 <- induced.subgraph(g, Vertices_in_word_association)

centrality = centralities(word_association_network2)

df <- tibble(names(centrality[[1]]) , names(centrality[[2]]), names(centrality[[3]]))
colnames(df) <- c("page_rank", "betweeness", "eigen_centrality")

df %>% gt() %>%
  tab_header(paste0("Top 5 words based on centralities based on word association network for
             words ",target_word1 , " and ",target_word2))

vertex_size <- 2 + degree(word_association_network2)/10
cex_size <- 1 + degree(word_association_network2)/30
ggraph(word_association_network2, layout = "fr")+
  geom_edge_link(start_cap = circle(2.5, "mm"),
                   end_cap = circle(2.5, "mm"),
                   edge_width = 0.2,
                   alpha = 0.2)+
  geom_node_point(aes(size = vertex_size), 
                    alpha = 0.8, 
                    colour = ifelse(V(word_association_network2) %in% c("HEART", "HEAD"), "yellow","red")) +
  geom_node_text(
      aes(label = name),
      fontface = "bold",
      size = cex_size,
      repel = TRUE
    ) 
```


```{r}
target_word1 <- "HEAD"
target_word2 <- "HEART"

check_cue_words(target_word1, target_word2)

out <- random_walk_topic_network(g, c(target_word1, target_word2), 3, 100, "all", 160)

Vertices_in_word_association <- V(g)[name %in% out]

word_association_network3 <- induced.subgraph(g, Vertices_in_word_association)

centrality = centralities(word_association_network3)

df <- tibble(names(centrality[[1]]) , names(centrality[[2]]), names(centrality[[3]]))
colnames(df) <- c("page_rank", "betweeness", "eigen_centrality")

df %>% gt() %>%
  tab_header(paste0("Top 5 words based on centralities based on word association network for
             words ",target_word1 , " and ",target_word2))

vertex_size <- 2.5 + degree(word_association_network3)/10
cex_size <-2 + degree(word_association_network3)/30
ggraph(word_association_network3, layout = "fr")+
  geom_edge_link(start_cap = circle(2.5, "mm"),
                   end_cap = circle(2.5, "mm"),
                   edge_width = 0.2,
                   alpha = 0.2)+
  geom_node_point(aes(size = vertex_size), 
                    alpha = 0.8, 
                    colour = ifelse(V(word_association_network3) %in% c("HEART", "HEAD"), "yellow","red")) +
  geom_node_text(
      aes(label = name),
      fontface = "bold",
      size = cex_size,
      repel = TRUE
    ) 
```


```{r}
#fast greedy community detection
cluster1 <- cluster_louvain(word_association_network1, weights = NA)
#louvain community detection
cluster2 <- cluster_louvain(word_association_network2, weights = NA)
#walktrap community detection
cluster3 <- cluster_louvain(word_association_network3)

create_community_table <- function(clustering_data){
  strings <- c()
  lengths <- c()
  for(i in 1:length(clustering_data)){
    string = ""
    for(word in clustering_data[[i]]){
      string = paste0(string, "'", word, "',")
    }
    
    strings <- append(strings, string)
    lengths <- append(lengths, length(clustering_data[[i]]))
  }
  df <- tibble(strings, lengths) %>%
    filter(lengths > 1 ) 
  colnames(df) <- c("Cluster","Size")
  
  return(df)
}


community_table1 <- create_community_table(cluster1)
community_table1 %>%
  arrange(desc(Size)) %>%
  kable() %>%
  column_spec(column = 1, width = "5in")

community_table2 <- create_community_table(cluster2)
community_table2 %>%
  arrange(desc(Size)) %>%
  kable() %>%
  column_spec(column = 1, width = "5in")

community_table3 <- create_community_table(cluster3)
community_table3 %>%
  arrange(desc(Size)) %>%
  kable() %>%
  column_spec(column = 1, width = "5in")
```

```{r, results='asis'}
#loop on the communities

define_community_labels <- function(cluster, dataframe){
  community_label = c()
  for (i in 1:length(cluster)){
    
    if (length(cluster[[i]]) > 1){
      vertices_in_community <- V(g)[name %in% cluster[[i]]]
      community_graph <- induced.subgraph(g, vertices_in_community)
      page_rank <- page_rank(community_graph)$vector
      label = sort(page_rank, decreasing = TRUE)[1]
      community_label <- c(community_label, label)
    }
  }
  dataframe<- dataframe %>% mutate(community_label = names(community_label))
  
  return(dataframe)
}

community_with_label<- define_community_labels(cluster1, community_table1)

community_with_label %>%
  arrange(desc(Size)) %>%
  kable() %>%
  column_spec(column = 1, width = "5in")

define_community_labels(cluster2, community_table2) %>%
  arrange(desc(Size)) %>%
  kable() %>%
  column_spec(column = 1, width = "5in")

out <-define_community_labels(cluster3, community_table3) %>%
  arrange(desc(Size)) 
  

kable(as.data.frame(out), booktabs = TRUE) %>%
  kable_styling(full_width = TRUE) 
  #column_spec(column = 1, width = "5in") 

dt <- tibble(
   Items = c("Item 1", "Item 2", "Item 3"),
   Text_1 = c("Lorem ipsum dolor sit amet, consectetur adipiscing elit. Proin vehicula tempor ex. Morbi malesuada sagittis turpis, at venenatis nisl luctus a. ","In eu urna at magna luctus rhoncus quis in nisl. Fusce in velit varius, posuere risus et, cursus augue. Duis eleifend aliquam ante, a aliquet ex tincidunt in. ", "Vivamus venenatis egestas eros ut tempus. Vivamus id est nisi. Aliquam molestie erat et sollicitudin venenatis. In ac lacus at velit scelerisque mattis. "),
   Text_2 = c("Duis posuere placerat magna, ac aliquam lorem viverra non. Ut ultrices tempus eros, quis sodales libero commodo non. In non neque ut lacus vestibulum dictum a quis ipsum. ", "Aenean ut justo interdum, laoreet enim nec, viverra eros. Donec vel pharetra nunc. Suspendisse vel ipsum ac lectus semper aliquam ac a orci. Suspendisse libero mauris, egestas semper auctor sit amet, tempor et orci. ", "Phasellus quis neque aliquet, finibus nunc eget, lacinia neque. Sed auctor lectus vel ex scelerisque commodo. ")
)

kable(dt, "latex", booktabs = T,
col.names = c("Item", "Short Title", "Very Very Very Very Very Very Long Title")) %>%
column_spec(2:3, width = "5cm")



t1w <-out %>% mutate(cl = paste0('"',Cluster,'"')) %>% select(cl)

kable( t1w, "latex", booktabs = T) %>%
  column_spec(1, width = "10cm")


```


